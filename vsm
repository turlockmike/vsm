#!/usr/bin/env bash
# vsm — Interactive VSM session
#
# Only acquires the brain lock. Responder keeps running so owner still
# gets Telegram/email replies while working interactively.
#
# Uses its own session (not shared with brain) for clean separation.

set -euo pipefail

VSM_ROOT="$HOME/projects/vsm/v2"
BRAIN_LOCK="$VSM_ROOT/state/actors/brain/lock"

cd "$VSM_ROOT"

# Wait for brain to finish if running
if [ -f "$BRAIN_LOCK" ]; then
    pid=$(cat "$BRAIN_LOCK" 2>/dev/null || echo "")
    if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
        echo "Waiting for brain (pid $pid) to finish..."
        while kill -0 "$pid" 2>/dev/null; do sleep 1; done
    fi
    rm -f "$BRAIN_LOCK"
fi

# Hold brain lock — cron brain backs off while we're here
echo $$ > "$BRAIN_LOCK"
trap 'rm -f "$BRAIN_LOCK"' EXIT

# Interactive session — own session, not shared with cron brain
claude
